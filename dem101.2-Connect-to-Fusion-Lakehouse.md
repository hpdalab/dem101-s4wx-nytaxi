# dem101.2 Connect Dataset to Fusion/Lakehouse


## dem101.2.1 Connect watsonx.data to dataset


#### Log into watsonx.data

![image](https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/0b33b950-8e4c-4cd5-994d-1025b852f0a4)

   
#### Navigate to Infrastructure Manager

<img width="1354" alt="image" src="https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/2f98a736-9e12-42c2-80c0-cccbb63b9750">


#### Add Component-Bucket for Object Storage

<img width="1356" alt="image" src="https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/fd8d14ee-e33e-4a96-bee6-ade90ddedf88">


#### View Bucket (bkt001) Content Directly

<img width="825" alt="image" src="https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/be54b8a7-1455-41f3-a64f-5d60b5b92a4f">


#### Navigate to Data Manager

![image](https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/64d180dc-f1eb-4ec3-a461-c413d7493d03)


#### Create Schema under Catalog bkt003c1

![image](https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/b4a82965-fdeb-48e4-814b-671c27459be6)


#### Navigate to Query Workspace

<img width="1224" alt="image" src="https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/67580606-8abc-467b-a89b-d8fc0984f851">


#### Run SQL Query to Create First Connected Table

<img width="1219" alt="image" src="https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/e047e828-97cd-4ae2-85fa-d394875f72c6">

SQL query to create table "bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_csv". Note varchar is the only acceptable data type for CSV-based table


```
CREATE TABLE bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_csv  (
    VendorID varchar,	
    TimePickup varchar,	
    TimeDropoff varchar,	
    PassengerCount varchar,	
    TripDistance varchar,	
    RatecodeID varchar,	
    StoreFwdFlag varchar,	
    PULocationID varchar,	
    DOLocationID varchar,		
    PaymentType varchar,
    Fare varchar,
    Extra varchar,
    MTAtax varchar,
    Tip varchar,
    Tolls varchar,
    Surcharge varchar,
    Total varchar
) 
WITH (format = 'csv', 
    external_location = 's3a://bkt001-s4wx/bkt001_nyctaxi/man/');
```

#### Table (bkt001_nyctaxi_csv) schema and data sample available under Data Manager
<img width="1199" alt="image" src="https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/64144cd5-4675-41e4-99bd-0fa31e4313c8">


#### Run 2nd SQL Query to Extract 5M Rows into New ORC-based Table

![image](https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/b9af31c1-07ce-4d76-9684-d3ed5c2b5f29)

SQL query to extract first 5M rows from "bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_csv" and convert into a new ORC-based table "bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_5M"

```
create table bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_5M
WITH (
  format = 'orc'
)
as 
select * from bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_csv LIMIT 5000000
```


#### Run 3rd SQL Query to Format Table Values into Correct Date Types

![image](https://github.com/hpdalab/dem101-s4wx-nytaxi/assets/38366661/a2916a1b-0a83-4544-9574-ab92424ac29b)


SQL query to convert table "bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_5M" into "bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_5M_orc" with all values formatted to the correst data types 


```
CREATE TABLE bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_5M_orc
COMMENT '2018 Newyork City taxi data 5M row'
WITH (FORMAT = 'ORC')
AS
SELECT 
    cast(vendorid as INTEGER) as vendorid,
    date_parse(timepickup, '%m/%d/%Y %h:%i:%s %p') as timepickup,
    date_parse(timedropoff, '%m/%d/%Y %h:%i:%s %p') as timedropoff,
    cast(passengercount as SMALLINT) as passengercount,
    cast(tripdistance as DECIMAL(8, 2)) as tripdistance,
    cast(ratecodeid as INTEGER) as ratecodeid,
    cast(storefwdflag as CHAR(1)) as storefwdflag,
    cast(pulocationid as INTEGER) as pulocationid,
    cast(dolocationid as INTEGER) as dolocationid,
    cast(paymenttype as SMALLINT) as paymenttype,
    cast(fare as DECIMAL(8, 2)) as fare,
    cast(extra as DECIMAL(8, 2)) as extra,
    cast(mtatax as DECIMAL(8, 2)) as mtatax,
    cast(tip as DECIMAL(8, 2)) as tip,
    cast(tolls as DECIMAL(8, 2)) as tolls,
    cast(surcharge as DECIMAL(8, 2)) as surcharge,
    cast(total as DECIMAL(8, 2)) as total
FROM bkt001c1.bkt001_nyctaxi.bkt001_nyctaxi_5M
```


